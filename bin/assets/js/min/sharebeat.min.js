var audiobus;!function(t){!function(t){var i=function(){function t(t,i){this.isPlaying=!1,this.hasInitialised=!1,this.durationFadeIn=.05,this.durationFadeOut=3,this.SILENCE=1e-8,this.context=t,this.gain=t.createGain(),this.gain.connect(i)}return t.prototype.start=function(){for(var t=[],i=0;i<arguments.length-0;i++)t[i]=arguments[i+0];this.context.currentTime;this.isPlaying=!0,this.hasInitialised=!0,console.log("start "+this.isPlaying)},t.prototype.stop=function(){this.hasInitialised&&this.isPlaying&&(this.fadeOut(this.durationFadeOut),console.log("stop vol:",this.gain),this.isPlaying=!1)},t.prototype.fadeIn=function(t){"undefined"==typeof t&&(t=.1);var i=this.context.currentTime;console.log("fading out in "+t),this.gain.gain.cancelScheduledValues(i),this.gain.gain.exponentialRampToValueAtTime(.5,i+t),this.gain.gain.setValueAtTime(.5,i+t)},t.prototype.onFaded=function(){alert("fade complete "+this.gain.gain)},t.prototype.fadeOut=function(t){"undefined"==typeof t&&(t=.1);var i=this.context.currentTime;console.log("fading out in "+t),this.gain.gain.cancelScheduledValues(i),this.gain.gain.exponentialRampToValueAtTime(this.SILENCE,i+t),this.gain.gain.setValueAtTime(0,i+t)},t}();t.Instrument=i}(t.instruments||(t.instruments={}));t.instruments}(audiobus||(audiobus={}));var __extends=this.__extends||function(t,i){function e(){this.constructor=t}for(var s in i)i.hasOwnProperty(s)&&(t[s]=i[s]);e.prototype=i.prototype,t.prototype=new e},audiobus;!function(t){!function(t){var i=function(t){function i(i,e){t.call(this,i,e),this.osc1=i.createOscillator(),this.osc1.type=0,this.osc1.connect(this.gain)}return __extends(i,t),i.prototype.start=function(i,e,s,n){"undefined"==typeof i&&(i=2050),"undefined"==typeof e&&(e=.005),"undefined"==typeof s&&(s=.01),"undefined"==typeof n&&(n=.7);var a=this.context.currentTime;this.gain.gain.cancelScheduledValues(a),this.gain.gain.setValueAtTime(1,a),this.gain.gain.linearRampToValueAtTime(1,a+s),this.gain.gain.linearRampToValueAtTime(0,a+n),this.osc1.frequency.setValueAtTime(i,a),this.osc1.frequency.exponentialRampToValueAtTime(80,a+e),this.hasInitialised||this.osc1.start(0),t.prototype.start.call(this)},i}(t.Instrument);t.BassDrum=i}(t.instruments||(t.instruments={}));t.instruments}(audiobus||(audiobus={}));var audiobus;!function(t){!function(t){var i=function(t){function i(i,e){t.call(this,i,e),this.noiseBuffer=i.createBuffer(1,22050,22050),this.noiseData=this.noiseBuffer.getChannelData(0);for(var s=0,n=this.noiseData.length;n>s;++s)this.noiseData[s]=2*(Math.random()-.5);this.noise=i.createBufferSource(),this.noise.loop=!0,this.noise.buffer=this.noiseBuffer,this.noise.connect(this.gain)}return __extends(i,t),i.prototype.start=function(i,e,s,n){"undefined"==typeof i&&(i=2050),"undefined"==typeof e&&(e=.025),"undefined"==typeof s&&(s=.05),"undefined"==typeof n&&(n=.3);var a=this.context.currentTime;this.gain.gain.cancelScheduledValues(a),this.gain.gain.setValueAtTime(1,a),this.gain.gain.linearRampToValueAtTime(1,a+e),this.gain.gain.exponentialRampToValueAtTime(.2,a+s),this.gain.gain.linearRampToValueAtTime(0,a+n),this.hasInitialised||this.noise.start(0),t.prototype.start.call(this)},i}(t.Instrument);t.Snare=i}(t.instruments||(t.instruments={}));t.instruments}(audiobus||(audiobus={}));var audiobus;!function(t){!function(t){var i=function(t){function i(i,e){t.call(this,i,e),this.osc5=i.createOscillator(),this.osc5.type=1,this.osc5.frequency.value=600,this.osc6=i.createOscillator(),this.osc6.type=1,this.osc6.frequency.value=900,this.osc7=i.createOscillator(),this.osc7.type=1,this.osc7.frequency.value=1300,this.osc8=i.createOscillator(),this.osc8.type=1,this.osc8.frequency.value=2e3,this.osc9=i.createOscillator(),this.osc9.type=1,this.osc9.frequency.value=2300,this.oscA=i.createOscillator(),this.oscA.type=1,this.oscA.frequency.value=2800,this.f1=i.createBiquadFilter(),this.f1.type=1,this.f1.frequency.value=1e4,this.f2=i.createBiquadFilter(),this.f2.type=1,this.f2.frequency.value=1e4,this.osc5.connect(this.f1),this.osc6.connect(this.f1),this.osc7.connect(this.f1),this.osc8.connect(this.f1),this.osc9.connect(this.f1),this.oscA.connect(this.f1),this.f1.connect(this.f2),this.f2.connect(this.gain)}return __extends(i,t),i.prototype.start=function(){var i=this.context.currentTime;this.f1.frequency.setValueAtTime(20,i),this.f1.frequency.linearRampToValueAtTime(16e3,i+.05),this.f2.frequency.setValueAtTime(20,i),this.f2.frequency.linearRampToValueAtTime(16e3,i+.05),this.gain.gain.cancelScheduledValues(i),this.gain.gain.setValueAtTime(.4,i),this.gain.gain.linearRampToValueAtTime(.4,i+.025),this.gain.gain.exponentialRampToValueAtTime(.1,i+.05),this.gain.gain.linearRampToValueAtTime(0,i+.3),this.hasInitialised||(this.osc5.start(0),this.osc6.start(0),this.osc7.start(0),this.osc8.start(0),this.osc9.start(0),this.oscA.start(0)),t.prototype.start.call(this)},i}(t.Instrument);t.HiHat=i}(t.instruments||(t.instruments={}));t.instruments}(audiobus||(audiobus={}));var audiobus;!function(t){!function(t){var i=function(t){function i(i,e){t.call(this,i,e),this.osc2=i.createOscillator(),this.osc2.type=0,this.osc2.connect(this.gain)}return __extends(i,t),i.prototype.start=function(i,e){"undefined"==typeof i&&(i=1200),"undefined"==typeof e&&(e=.16);var s=this.context.currentTime;this.osc2.frequency.setValueAtTime(i,s),this.osc2.frequency.linearRampToValueAtTime(800,s+.005),this.gain.gain.cancelScheduledValues(s),this.gain.gain.setValueAtTime(.5,s),this.gain.gain.exponentialRampToValueAtTime(.5,s+.01),this.gain.gain.linearRampToValueAtTime(0,s+e),this.hasInitialised||this.osc2.start(0),t.prototype.start.call(this)},i}(t.Instrument);t.Conga=i}(t.instruments||(t.instruments={}));t.instruments}(audiobus||(audiobus={}));var audiobus;!function(t){!function(t){var i=function(t){function i(i,e){t.call(this,i,e),this.oscB=i.createOscillator(),this.oscB.type=1,this.oscB.frequency.value=900,this.oscC=i.createOscillator(),this.oscC.type=1,this.oscC.frequency.value=1400,this.oscB.connect(this.gain),this.oscC.connect(this.gain)}return __extends(i,t),i.prototype.start=function(i,e,s){"undefined"==typeof i&&(i=.025),"undefined"==typeof e&&(e=.05),"undefined"==typeof s&&(s=.4);var n=this.context.currentTime;this.gain.gain.cancelScheduledValues(n),this.gain.gain.setValueAtTime(1,n),this.gain.gain.linearRampToValueAtTime(1,n+i),this.gain.gain.exponentialRampToValueAtTime(.2,n+e),this.gain.gain.linearRampToValueAtTime(0,n+s),this.hasInitialised||(this.oscB.start(0),this.oscC.start(0)),t.prototype.start.call(this)},i}(t.Instrument);t.CowBell=i}(t.instruments||(t.instruments={}));t.instruments}(audiobus||(audiobus={}));var audiobus;!function(t){var i=function(){function i(t,i){"undefined"==typeof t&&(t=null),"undefined"==typeof i&&(i=null),this.bpm=120;var e=this.initDSP(window);e?this.setup():alert("Web Audio API is not supported in this browser")}return i.prototype.initDSP=function(t){try{return t.AudioContext=t.AudioContext||t.webkitAudioContext||t.msAudioContext||t.mozAudioContext,this.dsp=new AudioContext,this.dsp.sampleRate=22050,!0}catch(i){return!1}},i.prototype.setup=function(){this.gain=this.dsp.createGain(),this.bassdrum=new t.instruments.BassDrum(this.dsp,this.gain),this.conga=new t.instruments.Conga(this.dsp,this.gain),this.snare=new t.instruments.Snare(this.dsp,this.gain),this.hihat=new t.instruments.HiHat(this.dsp,this.gain),this.cowbell=new t.instruments.CowBell(this.dsp,this.gain),this.gain.connect(this.dsp.destination)},i.prototype.trigger=function(t){switch("undefined"==typeof t&&(t=0),t){default:case 0:this.bassdrum.start(2050,.005,.01,.7);break;case 1:this.bassdrum.start(4050,.007,.01,.6);break;case 2:this.bassdrum.start(8050,.008,.03,.5);break;case 3:this.bassdrum.start(12050,.005,.01,.4);break;case 4:this.snare.start(2050,.005,.01,.1);break;case 5:this.snare.start(2050,.006,.02,.1);break;case 6:this.snare.start(2050,.007,.03,.1);break;case 7:this.snare.start(2050,.008,.04,.1);break;case 8:this.conga.start(1200,.16);break;case 9:this.conga.start(2200,.26);break;case 10:this.conga.start(3200,.36);break;case 11:this.conga.start(4200,.46);break;case 12:this.cowbell.start(.025,.05,.4);break;case 13:this.cowbell.start(.02,.04,.3);break;case 14:this.cowbell.start(.015,.03,.2);break;case 15:this.cowbell.start(.01,.02,.3);break;case 16:this.cowbell.start(.005,.01,.2)}},i}();t.DrumMachine=i}(audiobus||(audiobus={}));var audiobus;!function(t){!function(t){var i=function(t){function i(i,e){t.call(this,i,e),this.create()}return __extends(i,t),i.prototype.create=function(){this.osc=this.context.createOscillator(),this.osc.type=0,this.osc.connect(this.gain)},i.prototype.start=function(i){var e=this.context.currentTime;this.osc.frequency.value=i,this.gain.gain.cancelScheduledValues(e),this.isPlaying?this.gain.gain.value=.5:(this.gain.gain.exponentialRampToValueAtTime(.5,e+this.durationFadeIn),console.log("trying to start "+this.isPlaying+" state:"+this.osc.playbackState)),this.hasInitialised||this.osc.start(e),t.prototype.start.call(this)},i.prototype.stop=function(){this.hasInitialised&&(console.log("stop playing? "+this.isPlaying+" state:"+this.osc.playbackState),t.prototype.stop.call(this))},i}(t.Instrument);t.Sine=i}(t.instruments||(t.instruments={}));t.instruments}(audiobus||(audiobus={}));var audiobus;!function(t){!function(t){var i=function(t){function i(i,e){t.call(this,i,e),this.create()}return __extends(i,t),i.prototype.create=function(){this.osc=this.context.createOscillator(),this.osc.type=1,this.osc.connect(this.gain)},i.prototype.start=function(i){console.log("Sine commencing at f:"+i);var e=this.context.currentTime;this.osc.frequency.value=i,this.gain.gain.value=.5,this.hasInitialised||this.osc.start(e),t.prototype.start.call(this)},i}(t.Instrument);t.Saw=i}(t.instruments||(t.instruments={}));t.instruments}(audiobus||(audiobus={}));var audiobus;!function(t){!function(t){var i=function(){function t(t,i){this.context=t,this.gain=t.createGain(),this.gain.connect(i)}return t.prototype.getUserMedia=function(t,i,e){var s=navigator;return s.getUserMedia=s.getUserMedia||s.webkitGetUserMedia||s.mozGetUserMedia||s.msGetUserMedia,s.getUserMedia({video:!0,audio:!0},i,e)},t.prototype.getMic=function(){this.getUserMedia({audio:!0},this.onMicAvailable,this.onMicUnAvailable)},t.prototype.onMicAvailable=function(t){var i=this.context.createMediaStreamSource(t);this.gain.connect(i)},t.prototype.onMicUnAvailable=function(t){console.log("The following error occured: "+t)},t}();t.Microphone=i}(t.inputs||(t.inputs={}));t.inputs}(audiobus||(audiobus={}));var audiobus;!function(t){!function(t){var i=function(){function t(t,i){this.context=t,this.analyser=t.createAnalyser(),this.sampleRate=t.sampleRate,this.analyser.fftSize=2048,this.analyser.connect(t.destination),this.frequencyData=new Uint8Array(1024),this.gain=t.createGain(),this.gain.connect(i),this.gain.connect(this.analyser)}return t.prototype.update=function(){this.analyser.getByteFrequencyData(this.frequencyData),requestAnimationFrame(this.update)},t}();t.SpectrumAnalyzer=i}(t.visualisation||(t.visualisation={}));t.visualisation}(audiobus||(audiobus={}));var audiobus;!function(t){var i=function(){function t(t,i,e){this.period=6e3,this.playing=!1,this.percentage=0,this.callOnBeat=t,this.callOnProgress=i,this.callbackScope=e}return t.prototype.setBpm=function(t){if(1>t)return this.getBpm();var i=60/t;this.period=1e3*i,this.lastBarTimeStamp=this.determineStartTime();var e=Date.now()-this.lastBarTimeStamp;return this.percentage=e/this.period,t},t.prototype.getBpm=function(){return 60/(.001*this.period)>>0},t.prototype.start=function(t){"undefined"==typeof t&&(t=90);var i=this;this.playing=!0,this.setBpm(t),requestAnimationFrame(function(){return i.onTimer()})},t.prototype.stop=function(){this.playing=!1},t.prototype.determineStartTime=function(){var i=Date.now(),e=i-t.EPOCH,s=e%this.period,n=(this.period-s,i-s);return console.log("lastTick : "+n),n},t.prototype.incrementCuePoints=function(t){"undefined"==typeof t&&(t=-1),this.lastBarTimeStamp+=this.period},t.prototype.onTimer=function(){var t=this,i=Date.now(),e=i-this.lastBarTimeStamp,s=e/this.period,n=e>=this.period;n&&(this.incrementCuePoints(i),this.percentage=0,this.callOnBeat(this.callbackScope,i),this.onTimer()),s>this.percentage&&(this.percentage=s,this.callOnProgress(this.callbackScope,this.percentage)),this.playing&&requestAnimationFrame(function(){return t.onTimer()})},t.EPOCH=new Date(2012,12,21,6,6,6).getTime(),t}();t.Netronome=i}(audiobus||(audiobus={}));var FireBaseAPI=function(){function t(t,i){this.firstRun=!0,this.max=4,this.userid=-1,this.roomName="",this.tagChild="users",this.tagData="data",this.tagUser="",this.callback=t,this.callbackID=i}return t.prototype.connect=function(){var t=this;this.io=new Firebase("https://sharebeat.firebaseio.com/"),this.usersRef=this.io.child(this.tagChild),this.dataRef=this.io.child("data"),console.log("Frebase API connectin..."+this.io),this.io.on("child_added",function(i){return t.onChildAdded(i)}),this.dataRef.on("value",function(i){return t.onAudioData(i)})},t.prototype.disconnect=function(){-1!=this.userid&&this.unregisterUser()},t.prototype.onChildAdded=function(t){var i=t.name(),e=t.val();return 1==this.firstRun&&i==this.tagChild?(console.log("New user found ============= "),this.firstRun=!1,this.registerUser(e),!0):void 0},t.prototype.onChildChanged=function(){},t.prototype.onAudioData=function(t){var i=(t.name(),t.val());if(null!=i){var e=parseInt(i.id);this.userid!=e&&(console.log(i),this.callback(e,i.s,i.n))}},t.prototype.sendData=function(t,i){this.dataRef.set({id:this.userid,s:t,n:i})},t.prototype.registerUser=function(t){var i=0;for(var e in t){if(-1==t[e]){console.log("a free slot was found for this user "+i),this.userid=i;var s=this.io.child(this.tagChild);return s.child("user"+this.userid).set(this.userid),s.child("data").child("user"+this.userid).remove(),this.callbackID(this.userid),!0}i++}return this.callbackID(-1),!1},t.prototype.unregisterUser=function(){this.io.child("data").child("user"+this.userid).remove(),this.io.child(this.tagChild).child("user"+this.userid).set(-1)},t}(),Main=function(){function t(){var t=this;this.drums=new audiobus.DrumMachine,this.drums.trigger(),this.drums.trigger(1),this.drums.trigger(2),this.drums.trigger(3),this.drums.trigger(4),document.onkeydown=function(i){t.keyListener(i)}}return t.main=function(){new t},t.prototype.keyListener=function(t){switch(t||(t=window.event),t.keyCode){case 37:this.drums.trigger(1)}38==t.keyCode&&this.drums.trigger(2),39==t.keyCode&&this.drums.trigger(3),40==t.keyCode&&this.drums.trigger(4)},t}();$(document).ready(function(){function t(t){for(var i,e="",s=q.length;s>i;++i){var n=q[i],a=n+t,o=C.data(a);o&&(e+=n+" ")}return e}function i(i,s,n){"undefined"==typeof s&&(s=0),"undefined"==typeof n&&(n=!0);var a=q[s],o=parseInt(i.attr("alt")),r=o%V,u=o/V>>0,c=I-u,h=a+r,l=C.data(h),d="selected user"+a+" ";l&&e(l,s),d+=t(r),i.addClass(d),i.data("active"+a,c),C.data(h,i),n&&E.sendData(r,u)}function e(t,i){"undefined"==typeof i&&(i=0);var e=q[i],s=parseInt(t.attr("alt")),n=s%V,a=e+n;t.removeClass("selected user"+e),t.removeData("active"+e),C.removeData(a)}function s(t,i){var e,s=i+O;switch(t){case 0:e=s/12,e=440*e*e,_.start(e);break;case 1:M.trigger(i);break;case 2:e=(s-12)/12,e=440*e*e,U.start(e);break;case 3:e=s/12,e=440*e*e,F.start(e)}}function n(t){switch(t){case 0:_.stop();break;case 1:break;case 2:U.stop();break;case 3:F.stop()}}function a(){for(var t=0,i=q.length;i>t;++t){var e=q[t],a=e+D,o=C.data(a);if(o){var r=parseInt(o.attr("alt")),u=I-r/V>>0;s(t,u)}else n(t)}return L.css("left",100*D/V+"%"),D=(D+1)%V}function o(){return!0}function r(t){var i=$(t),e=i.data("activeA")||!1;e?c(i):u(i)}function u(t){i(t,E.userid)}function c(t){e(t,E.userid)}function h(){var t=$(this),s=t.data("activeA")||!1;s?e(t,E.userid):i(t,E.userid)}function l(){B?r(this):$(this).addClass("over")}function d(){$(this).removeClass("over")}function f(t,e,s){var n=e+I*s,a=$(z[n]);i(a,t,!1)}function p(){B=!0}function g(){B=!1}function m(t){switch(t>>=0){case-1:return y(),void 0;case 0:w.addClass("sine");break;case 1:w.addClass("drums");break;case 2:w.addClass("bass");break;case 3:w.addClass("saw")}R=!0,w.removeClass("loading"),G.start(P);var i=G.percentage*V;D=i>>0,C.show()}function y(){var t="I'm sorry, we had to limit the quantity of people using this app, perhaps try again later!";alert(t),w.removeClass("loading").addClass("error"),C.html(t)}function v(){A&&clearTimeout(A),A=setTimeout(b,400)}function b(){var t=x.width(),i=x.height();if(i>t)k.width("100%"),k.css("margin-left",0);else{k.width(i+"px");var e=$(window).width()-i;k.css("margin-left",.5*e)}}function T(){E.disconnect()}var A,w=$("body"),C=$("#matrix"),k=$("#content"),x=$(window),V=16,I=16,S=V*I,B=!1,R=!1,q=["A","B","C","D"],D=0,O=-10,P=200,M=new audiobus.DrumMachine,_=new audiobus.instruments.Sine(M.dsp,M.gain),U=new audiobus.instruments.Sine(M.dsp,M.gain),F=new audiobus.instruments.Saw(M.dsp,M.gain),G=new audiobus.Netronome(a,o,this),E=new FireBaseAPI(f,m);w.addClass("loading");for(var H="",N=0;S>N;++N)H+='<article alt="'+N+'" class="button"></article>';H+='<div class="progress"></div>',C.html(H),C.hide();var z=$("article.button",C),L=$("div.progress",C);C.mousedown(p),x.mouseup(g),z.mouseover(l),z.mouseout(d),z.click(h),window.onunload=T,x.resize(v),b(null),E.connect()});